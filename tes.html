<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisasi Molekul 3D Interaktif</title>
    <style>
        :root {
            --sidebar-width: 280px;
            --sidebar-width-collapsed: 0px;
            --transition-speed: 0.35s;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background-color: #111;
            color: #f0f0f0;
            overflow: hidden;
            transition: padding-left var(--transition-speed) ease;
        }
        body.sidebar-collapsed { padding-left: var(--sidebar-width-collapsed); }
        body:not(.sidebar-collapsed) { padding-left: var(--sidebar-width); }
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }
        #sidebar {
            position: fixed; top: 0; left: 0; height: 100vh;
            width: var(--sidebar-width); background-color: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px); border-right: 1px solid #333;
            z-index: 10; overflow-y: auto; overflow-x: hidden;
            transition: width var(--transition-speed) ease;
        }
        #sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        #sidebar-content { padding: 15px; }
        .sidebar-header {
            font-size: 1.8em; margin: 0 0 20px 0;
            color: #88ddff; text-align: center;
        }
        .sidebar-module h3 {
            border-bottom: 1px solid #444; padding-bottom: 8px;
            margin-bottom: 12px; font-weight: 500; color: #ccc;
        }
        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        .btn {
            background-color: #3a3a3a; color: #f0f0f0; border: 1px solid #555;
            padding: 10px 15px; border-radius: 6px; cursor: pointer;
            text-align: left; width: 100%; transition: background-color 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn:hover { background-color: #4a4a4a; }
        .btn.active { background-color: #007bff; border-color: #0056b3; }
        .detail-icon { font-size: 1.2em; transform: rotate(0deg); transition: transform 0.3s; }
        .detail-icon.rotated { transform: rotate(90deg); }
        .detail-menu {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out;
            background-color: rgba(0,0,0,0.2); margin-top: 5px; border-radius: 5px;
        }
        .detail-menu.visible { max-height: 200px; }
        .btn-detail-nav {
            background: none; border: none; color: #ddd; width: 100%;
            padding: 8px 15px; text-align: left; cursor: pointer;
        }
        .btn-detail-nav:hover { background-color: #555; }
        .btn-detail-nav.active { color: #88ddff; font-weight: bold; }

        .info-panel {
            position: fixed; bottom: 20px; right: 20px; z-index: 5;
            background: rgba(25, 25, 25, 0.85); backdrop-filter: blur(10px);
            border: 1px solid #444; border-radius: 8px;
            padding: 15px; max-width: 350px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: opacity 0.3s, transform 0.3s;
        }
        .info-panel.hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .info-panel h2 { margin: 0 0 10px 0; color: #88ddff; }
        .info-panel p { margin: 0; line-height: 1.6; color: #ddd; }
        .close-btn {
            position: absolute; top: 10px; right: 10px; background: none; border: none;
            color: #888; font-size: 1.5em; cursor: pointer;
        }
        #back-btn {
            position: fixed; top: 20px; z-index: 5;
            left: calc(var(--sidebar-width) + 20px);
            transition: left var(--transition-speed) ease;
        }
        body.sidebar-collapsed #back-btn { left: 20px; }
        #sidebar-toggle {
            position: fixed; top: 20px; left: calc(var(--sidebar-width) - 50px);
            z-index: 11; width: 40px; height: 40px; background: #333;
            border: 1px solid #555; color: white; cursor: pointer; border-radius: 50%;
            transition: left var(--transition-speed) ease;
        }
        body.sidebar-collapsed #sidebar-toggle { left: -50px; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="sidebar">
        <div id="sidebar-content"></div>
    </div>

    <button id="sidebar-toggle">&lt;</button>
    <button id="back-btn" class="btn hidden"></button>
    
    <div id="molecule-info-panel" class="info-panel hidden">
        <button id="close-molecule-info-btn" class="close-btn">&times;</button>
        <h2 id="molecule-info-title"></h2>
        <p id="molecule-info-description"></p>
    </div>

    <div id="detail-info-panel" class="info-panel hidden">
        <button id="close-detail-info-btn" class="close-btn">&times;</button>
        <h2 id="detail-info-title"></h2>
        <div id="detail-info-details"></div>
    </div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        // Import library Three.js dan modul-modul tambahannya.
        import * as THREE from "three";
        import { OrbitControls } from "three/addons/controls/OrbitControls.js";
        import { FontLoader } from "three/addons/loaders/FontLoader.js";
        import { TextGeometry } from "three/addons/geometries/TextGeometry.js";
        import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
        import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
        import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
        import { Sky } from 'three/addons/objects/Sky.js';

        // DATA: Objek utama yang menyimpan semua informasi tentang atom dan molekul.
        const DATA = {
            atoms: {
                H: { name: "Hidrogen", symbol: "H", color: 0xffffff, atomicNumber: 1, atomicMass: "1.008 u", electrons: [1], radius: 0.7, details: [
                    { title: "Etimologi & Sejarah", content: "Nama 'hidrogen' diberikan oleh Antoine Lavoisier pada tahun 1783, berasal dari kata Yunani 'hydro' (air) dan 'genes' (membentuk)..." },
                    { title: "Struktur & Komposisi", content: "Sebagai unsur paling sederhana, atom hidrogen netral terdiri dari satu proton tunggal di intinya dan satu elektron yang mengorbitnya..." },
                    { title: "Fakta Menarik / Trivia", content: "Hidrogen memiliki tiga isotop umum: Protium (¹H), Deuterium (²H), dan Tritium (³H)..." }
                ]},
                C: { name: "Karbon", symbol: "C", color: 0x606060, atomicNumber: 6, atomicMass: "12.011 u", electrons: [2, 4], radius: 1.1, details: [
                    { title: "Etimologi & Sejarah", content: "Nama 'karbon' berasal dari kata Latin 'carbo', yang berarti batu bara atau arang..." },
                    { title: "Peran dalam Biologi", content: "Karbon adalah 'tulang punggung' kimia dari semua kehidupan di Bumi..." },
                    { title: "Fakta Menarik / Trivia", content: "Isotop radioaktif Karbon-14 (¹⁴C) digunakan dalam penanggalan radiokarbon..." }
                ]},
                O: { name: "Oksigen", symbol: "O", color: 0xff0000, atomicNumber: 8, atomicMass: "15.999 u", electrons: [2, 6], radius: 1.0, details: [
                    { title: "Etimologi & Sejarah", content: "Nama 'oksigen' diciptakan oleh Antoine Lavoisier dari kata Yunani 'oxys' (asam) dan 'genes' (pembentuk)..." },
                    { title: "Peran dalam Biologi", content: "Oksigen sangat penting untuk respirasi seluler pada organisme aerobik..." },
                    { title: "Fakta Menarik / Trivia", content: "Meskipun vital untuk kehidupan, oksigen murni pada tekanan tinggi bisa menjadi racun..." }
                ]},
                N: { name: 'Nitrogen',  symbol: 'N',  color: 0x88aaff, atomicNumber: 7, atomicMass: "14.007 u", electrons: [2, 5], radius: 1.05, details: [ { title: "Info", content: "Detail untuk Nitrogen belum ditambahkan."} ]},
                P: { name: 'Fosfor',    symbol: 'P',  color: 0xffa500, atomicNumber: 15, atomicMass: "30.974 u", electrons: [2, 8, 5], radius: 1.3, details: [ { title: "Info", content: "Detail untuk Fosfor belum ditambahkan."} ]},
                S: { name: 'Belerang',  symbol: 'S',  color: 0xffff88, atomicNumber: 16, atomicMass: "32.06 u", electrons: [2, 8, 6], radius: 1.2, details: [ { title: "Info", content: "Detail untuk Belerang belum ditambahkan."} ]},
                Cl: { name: 'Klorin',    symbol: 'Cl', color: 0x88ff88, atomicNumber: 17, atomicMass: "35.45 u", electrons: [2, 8, 7], radius: 1.15, details: [ { title: "Info", content: "Detail untuk Klorin belum ditambahkan."} ]},
                F: { name: 'Fluor', symbol: 'F', color: 0x90e090, atomicNumber: 9, atomicMass: "18.998 u", electrons: [2, 7], radius: 0.9, details: [ { title: "Info", content: "Detail untuk Fluor belum ditambahkan."} ]},
                Br: { name: 'Bromin', symbol: 'Br', color: 0xa52a2a, atomicNumber: 35, atomicMass: "79.904 u", electrons: [2, 8, 18, 7], radius: 1.3, details: [ { title: "Info", content: "Detail untuk Bromin belum ditambahkan."} ]},
            },
            molecules: {
                H2O: { name: "Air (H₂O)", description: "Molekul polar dengan bentuk tekuk/bent (~104.5°). Memiliki muatan parsial negatif pada Oksigen dan positif pada Hidrogen.", details: [
                    { title: "Info Umum", content: "Air (H₂O) adalah substansi kimia dengan rumus kimia H₂O..." },
                    { title: "Sifat Fisik", content: "Air tidak berasa, tidak berbau pada kondisi standar..." }
                ]},
                CH4: { name: "Metana (CH₄)", description: "Molekul nonpolar dengan bentuk tetrahedral (~109.5°). Komponen utama gas alam.", details: [
                    { title: "Info Umum", content: "Metana adalah hidrokarbon paling sederhana..." },
                ]},
                CO2: { name: "Karbondioksida (CO₂)", description: "Molekul nonpolar dengan bentuk linear. Terdiri dari ikatan kovalen rangkap dua.", details: [
                    { title: "Info Umum", content: "Karbondioksida adalah gas yang secara alami ada di atmosfer..." },
                ]},
                C2H6: { name: "Etana (C₂H₆)", description: "Hidrokarbon jenuh dengan ikatan tunggal antara dua atom karbon.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                C6H6: { name: "Benzena (C₆H₆)", description: "Senyawa organik aromatik dengan cincin enam karbon.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                PH3: { name: "Fosfin (PH₃)", description: "Gas tidak berwarna dan mudah terbakar dengan struktur piramida trigonal.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                SF6: { name: "Belerang Heksafluorida (SF₆)", description: "Gas rumah kaca yang sangat poten dengan geometri oktahedral.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                CCl4: { name: "Karbon Tetraklorida (CCl₄)", description: "Senyawa organik volatil dengan geometri tetrahedral.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                C3H8: { name: "Propana (C₃H₈)", description: "Alkane tiga karbon, umum digunakan sebagai bahan bakar.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                CH2O: { name: "Formaldehida (CH₂O)", description: "Aldehida paling sederhana dengan struktur planar trigonal.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                CH3COCH3: { name: "Aseton (CH₃COCH₃)", description: "Keton paling sederhana, pelarut organik yang umum.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                CH3COOH: { name: "Asam Asetat (CH₃COOH)", description: "Komponen utama cuka, memberikan rasa asam.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                C8H10N4O2: { name: "Kafein (C₈H₁₀N₄O₂)", description: "Stimulan sistem saraf pusat dari kelas metilxantina.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
                C10H16N5O13P3: { name: "ATP (Adenosin Trifosfat)", description: "Nukleotida pembawa energi utama dalam sel.", details: [{ title: "Info", content: "Detail belum ditambahkan."}] },
            },
        };

        // Variabel global
        let scene, camera, renderer, controls, composer;
        let mainGroup, defaultFont;
        const canvasContainer = document.getElementById("canvas-container");
        const detailInfoPanel = document.getElementById('detail-info-panel');
        const moleculeInfoPanel = document.getElementById('molecule-info-panel');
        const sidebarContent = document.getElementById('sidebar-content');
        const body = document.body;
        let textLabelsToBillboard = [];
        let sky, sun;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        const clock = new THREE.Clock();

        let electronShells = [], electronsToAnimate = [];
        let isAnimationPaused = false;
        let electronGlowTexture;
        let lastHoveredAtom = null;

        let activeState = { type: 'molecule', key: 'H2O', menu: null };
        const backButton = document.getElementById('back-btn');
        
        // Inisialisasi
        function init() {
            body.classList.remove('sidebar-collapsed');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 0.5;
            canvasContainer.appendChild(renderer.domElement);
            
            sky = new Sky();
            sky.scale.setScalar(450000);
            scene.add(sky);
            sun = new THREE.Vector3();
            const effectController = { turbidity: 10, rayleigh: 3, mieCoefficient: 0.005, mieDirectionalG: 0.7, elevation: 2, azimuth: 180, exposure: 0.5 };
            function guiChanged() {
                const uniforms = sky.material.uniforms;
                uniforms['turbidity'].value = effectController.turbidity;
                uniforms['rayleigh'].value = effectController.rayleigh;
                uniforms['mieCoefficient'].value = effectController.mieCoefficient;
                uniforms['mieDirectionalG'].value = effectController.mieDirectionalG;
                const phi = THREE.MathUtils.degToRad(90 - effectController.elevation);
                const theta = THREE.MathUtils.degToRad(effectController.azimuth);
                sun.setFromSphericalCoords(1, phi, theta);
                uniforms['sunPosition'].value.copy(sun);
                renderer.toneMappingExposure = effectController.exposure;
            }
            guiChanged();
            
            mainGroup = new THREE.Group();
            scene.add(mainGroup);
            
            const ambientLight = new THREE.AmbientLight(0xcccccc, 0.7);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 5, 100);
            pointLight.position.set(0, 5, 10);
            pointLight.castShadow = true;
            scene.add(pointLight);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            const renderPass = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass( new THREE.Vector2(window.innerWidth, window.innerHeight), 0.15, 0.8, 0.99 );
            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            renderer.domElement.addEventListener("click", onClick, false);
            renderer.domElement.addEventListener('dblclick', onDoubleClick, false);
            renderer.domElement.addEventListener('mousemove', onMouseMove, false);
            
            electronGlowTexture = createGlowTexture('rgba(255, 255, 255, 1.0)', 'rgba(255, 255, 255, 0.0)');
            
            const fontLoader = new FontLoader();
            fontLoader.load("https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json", (font) => {
                defaultFont = font;
                buildSidebar();
                displayMolecule("H2O");
                setupUIListeners();
                animate();
            });
            window.addEventListener("resize", onWindowResize);
        }

        // Loop Animasi
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const delta = clock.getDelta();
            
            if (!isAnimationPaused && electronsToAnimate.length > 0) {
                electronsToAnimate.forEach(e => {
                    e.progress = (e.progress + e.speed * delta) % 1;
                    const newPosition = e.curve.getPoint(e.progress);
                    const posVec = new THREE.Vector3(newPosition.x, newPosition.y, 0);
                    posVec.applyEuler(e.orbitGroup.rotation);
                    e.object.position.copy(posVec);
                });
                electronShells.forEach((shell) => {
                    shell.rotation.y += 0.001;
                    shell.rotation.x += 0.0005;
                });
            }
            
            if (activeState.type === 'molecule') {
               const elapsedTime = clock.getElapsedTime();
               mainGroup.children.forEach(child => {
                 if (child.userData.type === 'atom' && child.userData.initialPosition) {
                   const initialPos = child.userData.initialPosition;
                   const swayX = Math.sin(elapsedTime * 1.1 + initialPos.y) * 0.08;
                   const swayY = Math.cos(elapsedTime * 1.3 + initialPos.x) * 0.07;
                   child.position.set(initialPos.x + swayX, initialPos.y + swayY, initialPos.z);
                 }
               });
            }
            
            textLabelsToBillboard.forEach((label) => {
              if (label) label.quaternion.copy(camera.quaternion);
            });

            composer.render();
        }

        // Manajemen Scene
        function clearScene() {
            textLabelsToBillboard = [];
            electronsToAnimate = [];
            electronShells = [];
            while (mainGroup.children.length > 0) {
                const object = mainGroup.children[0];
                object.traverse(node => {
                    if (node.isMesh) {
                        if (node.geometry) node.geometry.dispose();
                        if (node.material) {
                            if (Array.isArray(node.material)) node.material.forEach(m => m.dispose());
                            else node.material.dispose();
                        }
                    }
                });
                mainGroup.remove(object);
            }
        }

        // Fungsi Display
        function displayMolecule(moleculeKey) {
            clearScene();
            const moleculeData = DATA.molecules[moleculeKey];
            if (!moleculeData) return;
            
            activeState = { type: 'molecule', key: moleculeKey, menu: null };
            backButton.classList.add('hidden');
            
            drawMoleculeGeometry(moleculeKey);
            
            controls.autoRotate = true;
            detailInfoPanel.classList.add('hidden');
            updateMoleculeInfoPanel(moleculeData.name, moleculeData.description);
            buildSidebar();

            camera.position.set(0, 0, 15);
            controls.target.set(0, 0, 0);
        }

        function displayAtomDetail(atomKey) {
            clearScene();
            const atomData = DATA.atoms[atomKey];
            if (!atomData) return;
            
            const parentMoleculeKey = activeState.type === 'molecule' ? activeState.key : (activeState.parentMolecule || 'H2O');
            activeState = { type: 'atom', key: atomKey, menu: atomData.details[0]?.title, parentMolecule: parentMoleculeKey };
            
            backButton.innerHTML = `&larr; Kembali ke ${DATA.molecules[parentMoleculeKey].name}`;
            backButton.classList.remove('hidden');
            
            controls.autoRotate = false;
            moleculeInfoPanel.classList.add('hidden');
            
            const atom = createAtomMesh(1.2, atomData.color, atomData.symbol);
            mainGroup.add(atom);

            const title = `${atomData.name} (${atomData.symbol}) - No. Atom: ${atomData.atomicNumber}`;
            updateDetailInfoPanel(title, atomData.details, atomData.details[0]?.title);
            buildSidebar();
            camera.position.set(0, 0, 6);
            controls.target.set(0, 0, 0);
        }

        function displayElectronShell(atomKey) {
            clearScene();
            const data = DATA.atoms[atomKey];
            if (!data || !data.electrons) return;
            
            const parentAtomState = activeState.type === 'atom' ? activeState : activeState.parentAtomState;
            activeState = { type: 'electron_shell', key: atomKey, parentMolecule: parentAtomState.parentMolecule };

            backButton.innerHTML = `&larr; Kembali ke Detail Atom`;
            backButton.classList.remove('hidden');

            detailInfoPanel.classList.add('hidden');
            moleculeInfoPanel.classList.add('hidden');

            const nucleusMaterial = new THREE.MeshBasicMaterial({ color: data.color });
            const nucleusGeometry = new THREE.SphereGeometry(data.radius, 32, 32);
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            mainGroup.add(nucleus);

            const nucleusGlow = new THREE.Sprite(new THREE.SpriteMaterial({
                map: createGlowTexture(`rgba(255, 255, 255, 0.5)`, `rgba(255, 255, 255, 0.0)`),
                color: data.color, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false
            }));
            nucleusGlow.scale.set(data.radius * 4, data.radius * 4, 1.0);
            mainGroup.add(nucleusGlow);

            data.electrons.forEach((electronCount, shellIndex) => {
                const shellRadius = data.radius * 2.5 + (shellIndex * 3.0);
                const shellGroup = new THREE.Group();
                mainGroup.add(shellGroup);
                electronShells.push(shellGroup);

                const orbitCount = electronCount > 2 ? 5 : 1;
                const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x88ddff, transparent: true, opacity: 0.35 });
                const electronMaterial = new THREE.SpriteMaterial({
                    map: electronGlowTexture, color: 0xffffff, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false
                });

                const orbitData = [];
                for(let i = 0; i < orbitCount; i++) {
                    const curve = new THREE.EllipseCurve(0, 0, shellRadius, shellRadius, 0, 2 * Math.PI, false, 0);
                    const points = curve.getPoints(64);
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const orbitLine = new THREE.Line(geometry, orbitMaterial);
                    orbitLine.rotation.y = (i / orbitCount) * Math.PI;
                    orbitLine.rotation.x = Math.PI / 3;
                    shellGroup.add(orbitLine);
                    orbitData.push({ line: orbitLine, curve: curve });
                }

                for (let i = 0; i < electronCount; i++) {
                    const targetOrbitIndex = i % orbitCount;
                    const { curve: targetCurve } = orbitData[targetOrbitIndex];
                    const electronSprite = new THREE.Sprite(electronMaterial);
                    electronSprite.scale.set(1.5, 1.5, 1.0);
                    shellGroup.add(electronSprite); 
                    electronsToAnimate.push({
                        object: electronSprite, curve: targetCurve, orbitGroup: orbitData[targetOrbitIndex].line,
                        progress: (i / electronCount), speed: 0.12 + Math.random() * 0.06
                    });
                }
            });

            buildSidebar();
            camera.position.set(0, 0, data.electrons.length * 10 + 5);
            controls.target.set(0, 0, 0);
        }

        // Interaksi
        function onClick(event) {
            if (activeState.type !== 'molecule') return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            const clickedAtom = getHoveredAtom();
            if (clickedAtom) {
                displayAtomDetail(clickedAtom.userData.symbol);
            }
        }
        function onDoubleClick(event) {
            if (activeState.type !== 'atom') return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            const clickedAtom = getHoveredAtom();
            if (clickedAtom && clickedAtom.userData.symbol === activeState.key) {
                displayElectronShell(clickedAtom.userData.symbol);
            }
        }

        // UI
        function setupUIListeners() {
            backButton.addEventListener('click', () => {
                if(activeState.type === 'electron_shell') {
                    displayAtomDetail(activeState.key);
                } else if (activeState.type === 'atom') {
                    displayMolecule(activeState.parentMolecule);
                }
            });
            document.getElementById('close-detail-info-btn').addEventListener('click', () => detailInfoPanel.classList.add('hidden'));
            document.getElementById('close-molecule-info-btn').addEventListener('click', () => moleculeInfoPanel.classList.add('hidden'));
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
                body.classList.toggle('sidebar-collapsed');
                setTimeout(onWindowResize, 350);
            });
        }

        function buildSidebar() {
            sidebarContent.innerHTML = '';
            if (activeState.type === 'molecule') {
                buildMoleculeGallery();
            } else if (activeState.type === 'atom' || activeState.type === 'electron_shell') {
                buildAtomDetailMenu();
            }
        }

        function buildAtomDetailMenu() {
            const atomKey = activeState.key;
            const atomData = DATA.atoms[atomKey];
            if (!atomData) return;
            
            const header = document.createElement('h1');
            header.className = 'sidebar-header';
            header.textContent = atomData.name;
            sidebarContent.appendChild(header);

            if (activeState.type === 'atom' && atomData.details) {
                const module = document.createElement('div');
                module.className = 'sidebar-module';
                const h3 = document.createElement('h3');
                h3.textContent = 'Detail Informasi';
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';

                atomData.details.forEach(detail => {
                    const navBtn = document.createElement('button');
                    navBtn.className = 'btn';
                    if (detail.title === activeState.menu) navBtn.classList.add('active');
                    navBtn.textContent = detail.title;
                    navBtn.addEventListener('click', () => {
                        activeState.menu = detail.title;
                        const title = `${atomData.name} (${atomData.symbol}) - No. Atom: ${atomData.atomicNumber}`;
                        updateDetailInfoPanel(title, atomData.details, detail.title);
                        buildSidebar();
                    });
                    btnGroup.appendChild(navBtn);
                });
                module.appendChild(h3);
                module.appendChild(btnGroup);
                sidebarContent.appendChild(module);
            }

            if (activeState.type === 'electron_shell') {
                // UI Kontrol Animasi (opsional)
            }
        }

        function buildMoleculeGallery() {
            const header = document.createElement('h1');
            header.className = 'sidebar-header';
            header.textContent = 'MolEdu';
            sidebarContent.appendChild(header);
            
            const module = document.createElement('div');
            module.className = 'sidebar-module';
            const h3 = document.createElement('h3');
            h3.textContent = 'Galeri Molekul';
            const btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group';

            Object.keys(DATA.molecules).forEach(key => {
                const molData = DATA.molecules[key];
                const entry = document.createElement('div');
                entry.className = 'molecule-entry';

                const btn = document.createElement('button');
                btn.className = 'btn';
                if (key === activeState.key) btn.classList.add('active');
                btn.innerHTML = `<span>${molData.name}</span>`;
                btn.addEventListener('click', () => {
                    if (activeState.key === key && activeState.type === 'molecule') return;
                    displayMolecule(key);
                });
                
                entry.appendChild(btn);
                btnGroup.appendChild(entry);
            });
            
            module.appendChild(h3);
            module.appendChild(btnGroup);
            sidebarContent.appendChild(module);
        }

        // Fungsi Helper
        function createGlowTexture(color1, color2) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0.0, color1);
            gradient.addColorStop(1.0, color2);
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }
        function onWindowResize() {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
            composer.setSize(newWidth, newHeight);
        }
        function updateDetailInfoPanel(title, details, focusedSectionTitle = null) {
            document.getElementById("detail-info-title").textContent = title;
            const container = document.getElementById("detail-info-details");
            container.innerHTML = '';

            if (Array.isArray(details)) {
                const sections = focusedSectionTitle ? details.filter(i => i.title === focusedSectionTitle) : details;
                sections.forEach(item => {
                    const section = document.createElement('div');
                    section.innerHTML = `<h3>${item.title}</h3><p>${item.content}</p>`;
                    container.appendChild(section);
                });
            }
            detailInfoPanel.classList.remove('hidden');
        }
        function updateMoleculeInfoPanel(title, description) {
            if (!description) {
                moleculeInfoPanel.classList.add('hidden');
                return;
            }
            document.getElementById('molecule-info-title').textContent = title;
            document.getElementById('molecule-info-description').innerHTML = description;
            moleculeInfoPanel.classList.remove('hidden');
        }
        
        // --- Fungsi Pembuat Objek 3D ---
        function createAtomMesh(radius, color, symbol, charge = null, chargeColor = 0xffffff) {
            const atomGroup = new THREE.Group();
            const sphereGeometry = new THREE.SphereGeometry(radius, 64, 64);
            const sphereMaterial = new THREE.MeshPhysicalMaterial({ color, transmission: 0.9, roughness: 0.1, metalness: 0.1, reflectivity: 0.5, ior: 1.5, thickness: 0.8, transparent: true, opacity: 0.8, emissive: color, emissiveIntensity: 0.2 });
            const atomSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            atomSphere.castShadow = true;
            atomSphere.receiveShadow = true;
            atomGroup.add(atomSphere);
            atomGroup.userData = { type: "atom", symbol: symbol, originalEmissive: sphereMaterial.emissiveIntensity };

            if (defaultFont) {
                const textGroup = new THREE.Group();
                atomGroup.add(textGroup);
                textLabelsToBillboard.push(textGroup);
                const textGeometry = new TextGeometry(symbol, { font: defaultFont, size: radius * (charge ? 0.6 : 0.8), height: 0.1 });
                textGeometry.center();
                const textMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.6, depthTest: false });
                const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                if (charge) textMesh.position.y = radius * 0.2;
                textGroup.add(textMesh);
                if (charge) {
                    const chargeGeometry = new TextGeometry(charge, { font: defaultFont, size: radius * 0.5, height: 0.05 });
                    chargeGeometry.center();
                    const chargeMaterial = new THREE.MeshStandardMaterial({ color: chargeColor, emissive: chargeColor, emissiveIntensity: 0.8, depthTest: false });
                    const chargeMesh = new THREE.Mesh(chargeGeometry, chargeMaterial);
                    chargeMesh.position.y = -radius * 0.35;
                    textGroup.add(chargeMesh);
                }
            }
            return atomGroup;
        }

        function createBondMesh(pos1, pos2, radius = 0.1) {
            const direction = new THREE.Vector3().subVectors(pos2, pos1);
            const orientation = new THREE.Matrix4().lookAt(pos1, pos2, new THREE.Object3D().up);
            orientation.multiply(new THREE.Matrix4().makeRotationX(Math.PI / 2));
            const geometry = new THREE.CylinderGeometry(radius, radius, direction.length(), 32, 1);
            const bond = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ color: 0xcccccc, transparent: true, opacity: 0.4, roughness: 0.8 }));
            bond.castShadow = true;
            bond.receiveShadow = true;
            bond.applyMatrix4(orientation);
            bond.position.copy(pos1).add(direction.multiplyScalar(0.5));
            return bond;
        }
        
        // --- Router & Fungsi Menggambar Molekul ---
        function drawMoleculeGeometry(key) {
            const allFuncs = {
                H2O: drawWater, CH4: drawMethane, CO2: drawCarbonDioxide, C2H6: drawEthane, 
                C6H6: drawBenzene, PH3: drawPhosphine, SF6: drawSulfurHexafluoride,
                CCl4: drawCarbonTetrachloride, C3H8: drawPropane, CH2O: drawFormaldehyde,
                CH3COCH3: drawAcetone, CH3COOH: drawAceticAcid, C8H10N4O2: drawCaffeine,
                C10H16N5O13P3: drawATP
            };
            if (allFuncs[key]) allFuncs[key]();
        }
        
        // --- Koleksi Fungsi Menggambar Molekul ---
        
        function addSway(atom) {
            if (atom) atom.userData.initialPosition = atom.position.clone();
        }

        function drawWater() {
            const o = createAtomMesh(0.8, DATA.atoms.O.color, 'O', "-", 0xff8888); addSway(o);
            const h1 = createAtomMesh(0.5, DATA.atoms.H.color, 'H', "+", 0x8888ff);
            const h2 = createAtomMesh(0.5, DATA.atoms.H.color, 'H', "+", 0x8888ff);
            const angle = (104.5 * Math.PI) / 180;
            const bondLength = 2.0;
            h1.position.set(bondLength * Math.cos(angle / 2), bondLength * Math.sin(angle / 2), 0); addSway(h1);
            h2.position.set(bondLength * Math.cos(angle / 2), -bondLength * Math.sin(angle / 2), 0); addSway(h2);
            mainGroup.add(o, h1, h2);
            mainGroup.add(createBondMesh(o.position, h1.position, 0.08));
            mainGroup.add(createBondMesh(o.position, h2.position, 0.08));
        }

        function drawMethane() {
            const c = createAtomMesh(0.9, DATA.atoms.C.color, 'C'); addSway(c);
            mainGroup.add(c);
            const positions = [ new THREE.Vector3(1, 1, 1), new THREE.Vector3(1, -1, -1), new THREE.Vector3(-1, 1, -1), new THREE.Vector3(-1, -1, 1) ];
            positions.forEach((pos) => {
                const h = createAtomMesh(0.5, DATA.atoms.H.color, 'H');
                h.position.copy(pos.normalize().multiplyScalar(2.5)); addSway(h);
                mainGroup.add(h);
                mainGroup.add(createBondMesh(c.position, h.position, 0.08));
            });
        }

        function drawCarbonDioxide() {
            const c = createAtomMesh(0.9, DATA.atoms.C.color, 'C');
            const o1 = createAtomMesh(0.8, DATA.atoms.O.color, 'O');
            const o2 = createAtomMesh(0.8, DATA.atoms.O.color, 'O');
            const bondLength = 2.8;
            const doubleBondOffset = 0.18;
            o1.position.x = -bondLength;
            o2.position.x = bondLength;
            addSway(c); addSway(o1); addSway(o2);
            mainGroup.add(c, o1, o2);
            mainGroup.add(createBondMesh(c.position.clone().setY(doubleBondOffset), o1.position.clone().setY(doubleBondOffset), 0.08));
            mainGroup.add(createBondMesh(c.position.clone().setY(-doubleBondOffset), o1.position.clone().setY(-doubleBondOffset), 0.08));
            mainGroup.add(createBondMesh(c.position.clone().setY(doubleBondOffset), o2.position.clone().setY(doubleBondOffset), 0.08));
            mainGroup.add(createBondMesh(c.position.clone().setY(-doubleBondOffset), o2.position.clone().setY(-doubleBondOffset), 0.08));
        }

        function drawEthane() {
            const c1 = createAtomMesh(1.1, 0x606060, 'C'); c1.position.x = -0.77; addSway(c1);
            const c2 = createAtomMesh(1.1, 0x606060, 'C'); c2.position.x = 0.77; addSway(c2);
            mainGroup.add(c1, c2, createBondMesh(c1.position, c2.position, 0.15));
            const h_positions = [
                [-1.17, 1.0, 0], [-1.17, -0.5, 0.87], [-1.17, -0.5, -0.87],
                [1.17, -1.0, 0], [1.17, 0.5, 0.87], [1.17, 0.5, -0.87]
            ];
            h_positions.forEach(pos => {
                const h = createAtomMesh(0.7, 0xffffff, 'H');
                h.position.set(pos[0]*1.5, pos[1]*1.5, pos[2]*1.5); addSway(h);
                const c = pos[0] < 0 ? c1 : c2;
                mainGroup.add(h, createBondMesh(c.position, h.position, 0.1));
            });
        }
        
        function drawBenzene() {
            const atoms = [];
            const bondLength = 2.0;
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const x = bondLength * Math.cos(angle);
                const y = bondLength * Math.sin(angle);
                const c = createAtomMesh(1.1, 0x606060, 'C');
                c.position.set(x, y, 0); addSway(c);
                const h = createAtomMesh(0.7, 0xffffff, 'H');
                h.position.set(x * 1.5, y * 1.5, 0); addSway(h);
                mainGroup.add(c, h, createBondMesh(c.position, h.position, 0.1));
                atoms.push(c);
            }
            for (let i = 0; i < 6; i++) {
                const c1 = atoms[i];
                const c2 = atoms[(i + 1) % 6];
                if (i % 2 === 0) {
                    mainGroup.add(createBondMesh(c1.position.clone().setZ(0.15), c2.position.clone().setZ(0.15), 0.12));
                    mainGroup.add(createBondMesh(c1.position.clone().setZ(-0.15), c2.position.clone().setZ(-0.15), 0.12));
                } else {
                    mainGroup.add(createBondMesh(c1.position, c2.position, 0.15));
                }
            }
        }
        
        function drawPhosphine() {
            const p = createAtomMesh(DATA.atoms.P.radius, DATA.atoms.P.color, 'P'); addSway(p);
            mainGroup.add(p);
            const bondLength = 2.5;
            const angle = 93.5 * Math.PI / 180;
            const positions = [
                new THREE.Vector3(0, bondLength, 0),
                new THREE.Vector3(bondLength * Math.sin(angle), -bondLength * Math.cos(angle), 0),
                new THREE.Vector3(-bondLength * Math.sin(angle) * 0.5, -bondLength * Math.cos(angle), -bondLength * Math.sin(angle) * 0.866),
            ];
            positions.forEach(pos => {
                const h = createAtomMesh(DATA.atoms.H.radius, DATA.atoms.H.color, 'H');
                h.position.copy(pos); addSway(h);
                mainGroup.add(h, createBondMesh(p.position, h.position, 0.1));
            });
            mainGroup.rotation.x = -Math.PI / 4;
        }

        function drawSulfurHexafluoride() {
            const s = createAtomMesh(DATA.atoms.S.radius, DATA.atoms.S.color, 'S'); addSway(s);
            mainGroup.add(s);
            const bondLength = 2.8;
            const positions = [
                new THREE.Vector3(bondLength, 0, 0), new THREE.Vector3(-bondLength, 0, 0),
                new THREE.Vector3(0, bondLength, 0), new THREE.Vector3(0, -bondLength, 0),
                new THREE.Vector3(0, 0, bondLength), new THREE.Vector3(0, 0, -bondLength),
            ];
            positions.forEach(pos => {
                const f = createAtomMesh(DATA.atoms.F.radius, DATA.atoms.F.color, 'F');
                f.position.copy(pos); addSway(f);
                mainGroup.add(f, createBondMesh(s.position, f.position, 0.1));
            });
        }
        
        function drawCarbonTetrachloride() {
            const c = createAtomMesh(DATA.atoms.C.radius, DATA.atoms.C.color, 'C'); addSway(c);
            mainGroup.add(c);
            const bondLength = 3.0;
            const positions = [
                new THREE.Vector3(1, 1, 1), new THREE.Vector3(1, -1, -1),
                new THREE.Vector3(-1, 1, -1), new THREE.Vector3(-1, -1, 1)
            ];
            positions.forEach(pos => {
                const cl = createAtomMesh(DATA.atoms.Cl.radius, DATA.atoms.Cl.color, 'Cl');
                cl.position.copy(pos.normalize().multiplyScalar(bondLength)); addSway(cl);
                mainGroup.add(cl, createBondMesh(c.position, cl.position, 0.15));
            });
        }
        
        function drawPropane() {
            const angle = 109.5 * Math.PI / 180; const cc_bond = 1.54;
            const c1 = createAtomMesh(1.1, 0x606060, 'C'); addSway(c1);
            const c2 = createAtomMesh(1.1, 0x606060, 'C'); addSway(c2);
            const c3 = createAtomMesh(1.1, 0x606060, 'C'); addSway(c3);
            c2.position.x = cc_bond;
            c3.position.set(cc_bond + cc_bond * Math.cos(angle - Math.PI/2), cc_bond * Math.sin(angle - Math.PI/2), 0);
            mainGroup.add(c1, c2, c3);
            mainGroup.add(createBondMesh(c1.position, c2.position, 0.15));
            mainGroup.add(createBondMesh(c2.position, c3.position, 0.15));
            const h_positions = [
                [-0.5, 0.9, 0], [-0.5, -0.5, 0.9], [-0.5, -0.5, -0.9], [cc_bond, 0, 1.1], [cc_bond, 0, -1.1],
                [c3.position.x+0.5, c3.position.y-0.9, 0], [c3.position.x-0.5, c3.position.y+0.5, 0.9], [c3.position.x-0.5, c3.position.y+0.5, -0.9]
            ];
            h_positions.forEach((pos, i) => {
                const h = createAtomMesh(0.7, 0xffffff, 'H');
                h.position.set(pos[0], pos[1], pos[2]).multiplyScalar(1.5); addSway(h);
                let c = (i >= 3 && i <= 4) ? c2 : (i > 4 ? c3 : c1);
                mainGroup.add(h, createBondMesh(c.position, h.position, 0.1));
            });
            const center = new THREE.Vector3().add(c1.position).add(c3.position).divideScalar(2);
            mainGroup.children.forEach(child => child.position.sub(center));
        }

        function drawFormaldehyde() {
            const c = createAtomMesh(1.1, 0x606060, 'C'); addSway(c);
            const o = createAtomMesh(1.0, 0xff0000, 'O'); o.position.y = 1.2; addSway(o);
            const h1 = createAtomMesh(0.7, 0xffffff, 'H'); h1.position.set(-1.0, -0.6, 0); addSway(h1);
            const h2 = createAtomMesh(0.7, 0xffffff, 'H'); h2.position.set(1.0, -0.6, 0); addSway(h2);
            mainGroup.add(c, o, h1, h2);
            mainGroup.add(createBondMesh(c.position, h1.position, 0.1));
            mainGroup.add(createBondMesh(c.position, h2.position, 0.1));
            mainGroup.add(createBondMesh(c.position.clone().setX(0.15), o.position.clone().setX(0.15), 0.12));
            mainGroup.add(createBondMesh(c.position.clone().setX(-0.15), o.position.clone().setX(-0.15), 0.12));
        }

        function drawAcetone() {
            const c1 = createAtomMesh(1.1, 0x606060, 'C'); c1.position.x = -1.5; addSway(c1);
            const c2 = createAtomMesh(1.1, 0x606060, 'C'); addSway(c2);
            const c3 = createAtomMesh(1.1, 0x606060, 'C'); c3.position.x = 1.5; addSway(c3);
            const o = createAtomMesh(1.0, 0xff0000, 'O'); o.position.y = 1.2; addSway(o);
            mainGroup.add(c1, c2, c3, o);
            mainGroup.add(createBondMesh(c1.position, c2.position, 0.15));
            mainGroup.add(createBondMesh(c3.position, c2.position, 0.15));
            mainGroup.add(createBondMesh(c2.position.clone().setX(0.15), o.position.clone().setX(0.15), 0.12));
            mainGroup.add(createBondMesh(c2.position.clone().setX(-0.15), o.position.clone().setX(-0.15), 0.12));
            [-1.8, 1.8].forEach(x => {
                for(let i=0; i<3; i++){
                    const h = createAtomMesh(0.7, 0xffffff, 'H');
                    const angle = i * 2 * Math.PI / 3;
                    h.position.set(x + Math.cos(angle)*0.5, Math.sin(angle)*0.9, -0.5); addSway(h);
                    mainGroup.add(h, createBondMesh(x < 0 ? c1.position : c3.position, h.position, 0.1));
                }
            });
        }
        
        function drawAceticAcid() {
            const c1 = createAtomMesh(1.1, 0x606060, 'C'); c1.position.x = -1.5; addSway(c1);
            const c2 = createAtomMesh(1.1, 0x606060, 'C'); addSway(c2);
            const o1 = createAtomMesh(1.0, 0xff0000, 'O'); o1.position.y = 1.2; addSway(o1);
            const o2 = createAtomMesh(1.0, 0xff0000, 'O'); o2.position.set(1.0, -0.8, 0); addSway(o2);
            const h_acid = createAtomMesh(0.7, 0xffffff, 'H'); h_acid.position.set(1.7, -0.2, 0); addSway(h_acid);
            mainGroup.add(c1, c2, o1, o2, h_acid);
            mainGroup.add(createBondMesh(c1.position, c2.position, 0.15));
            mainGroup.add(createBondMesh(c2.position, o2.position, 0.15));
            mainGroup.add(createBondMesh(o2.position, h_acid.position, 0.1));
            mainGroup.add(createBondMesh(c2.position.clone().setZ(0.15), o1.position.clone().setZ(0.15), 0.12));
            mainGroup.add(createBondMesh(c2.position.clone().setZ(-0.15), o1.position.clone().setZ(-0.15), 0.12));
            for(let i=0; i<3; i++){
                const h = createAtomMesh(0.7, 0xffffff, 'H');
                const angle = i * 2 * Math.PI / 3;
                h.position.set(-1.8 + Math.cos(angle)*0.5, Math.sin(angle)*0.9, -0.5); addSway(h);
                mainGroup.add(h, createBondMesh(c1.position, h.position, 0.1));
            }
        }

        function drawCaffeine() {
            const atoms = {};
            function createAtom(name, x, y, z, symbol) {
                const atomData = DATA.atoms[symbol];
                const atom = createAtomMesh(atomData.radius * 0.8, atomData.color, symbol);
                atom.position.set(x, y, z);
                addSway(atom);
                atoms[name] = atom;
                mainGroup.add(atom);
            }
            createAtom('N1', 0.0, 1.3, 0, 'N'); createAtom('C2', 1.2, 0.8, 0, 'C');
            createAtom('N3', 1.2, -0.6, 0, 'N'); createAtom('C4', 0.0, -1.3, 0, 'C');
            createAtom('C5', -1.2, -0.6, 0, 'C'); createAtom('C6', -1.2, 0.8, 0, 'C');
            createAtom('O2', 2.2, 1.5, 0, 'O'); createAtom('O6', -2.2, 1.5, 0, 'O');
            createAtom('N7', -2.2, -1.3, 0, 'N'); createAtom('C8', -3.0, -0.3, 0, 'C');
            createAtom('N9', -2.2, 0.6, 0, 'N'); 
            createAtom('C1_Me', 0.0, 2.6, 0, 'C'); createAtom('C3_Me', 2.4, -1.3, 0, 'C');
            createAtom('C7_Me', -3.4, -2.1, 0, 'C');
            
            const bonds = [['N1','C2'], ['C2','N3'], ['N3','C4'], ['C4','C5'], ['C5','C6'], ['C6','N1'], ['C4','N9'], ['N9','C8'], ['C8','N7'], ['N7','C5'], ['C2','O2', true], ['C6','O6', true], ['N1', 'C1_Me'], ['N3', 'C3_Me'], ['N7', 'C7_Me']];
            bonds.forEach(([a, b, isDouble]) => {
                if(isDouble) {
                    mainGroup.add(createBondMesh(atoms[a].position.clone().setZ(0.1), atoms[b].position.clone().setZ(0.1), 0.1));
                    mainGroup.add(createBondMesh(atoms[a].position.clone().setZ(-0.1), atoms[b].position.clone().setZ(-0.1), 0.1));
                } else {
                     mainGroup.add(createBondMesh(atoms[a].position, atoms[b].position, 0.12));
                }
            });
            mainGroup.scale.set(1.5, 1.5, 1.5);
        }

        function drawATP() {
            const scale = 2.5; const atoms = {};
            function createA(name, x, y, z, symbol) {
                const atomData = DATA.atoms[symbol];
                const atom = createAtomMesh(atomData.radius * 0.5, atomData.color, symbol);
                atom.position.set(x, y, z).multiplyScalar(scale);
                addSway(atom);
                atoms[name] = atom;
                mainGroup.add(atom);
            }
            createA('Ad_N1', 0, 3, 0, 'N'); createA('Ad_C2', 1.2, 2.5, 0, 'C'); createA('Ad_N3', 1.2, 1.2, 0, 'N'); createA('Ad_C4', 0, 0.5, 0, 'C'); createA('Ad_C5', -1.2, 1.2, 0, 'C'); createA('Ad_C6', -1.2, 2.5, 0, 'C'); createA('Ad_N7', -2.2, 0.5, 0, 'N'); createA('Ad_C8', -3, 1.5, 0, 'C'); createA('Ad_N9', -2.2, 2.5, 0, 'N'); createA('Ad_N6', -2.2, 3.5, 0, 'N'); createA('R_C1', -3.5, 3.5, 0, 'C'); createA('R_O4', -4.5, 2.5, 0, 'O'); createA('R_C2', -3.5, 4.8, 0, 'C'); createA('R_C3', -4.8, 4.8, 0, 'C'); createA('R_C4', -5.5, 3.5, 0, 'C'); createA('R_C5', -6.8, 4.0, 0, 'C'); createA('R_O5', -7.8, 3.0, 0, 'O'); createA('P_A', -9, 3.5, 0, 'P'); createA('O_A1', -9, 5, 0, 'O'); createA('O_A2', -10, 2.8, 0, 'O'); createA('O_AB', -10.5, 4.5, 0, 'O'); createA('P_B', -11.5, 4.0, 0, 'P'); createA('O_B1', -11.5, 2.5, 0, 'O'); createA('O_BC', -13, 4.5, 0, 'O'); createA('P_G', -14, 4.0, 0, 'P'); createA('O_G1', -14, 2.5, 0, 'O'); createA('O_G2', -15, 4.7, 0, 'O');

            const bonds = [['Ad_N1', 'Ad_C2'], ['Ad_C2', 'Ad_N3'], ['Ad_N3', 'Ad_C4'], ['Ad_C4', 'Ad_C5'], ['Ad_C5', 'Ad_C6'], ['Ad_C6', 'Ad_N1'], ['Ad_C4', 'Ad_N9'], ['Ad_N9', 'Ad_C8'], ['Ad_C8', 'Ad_N7'], ['Ad_N7', 'Ad_C5'], ['Ad_C6', 'Ad_N6'], ['Ad_N9', 'R_C1'], ['R_C1', 'R_C2'], ['R_C2', 'R_C3'], ['R_C3', 'R_C4'], ['R_C4', 'R_O4'], ['R_O4', 'R_C1'], ['R_C4', 'R_C5'], ['R_C5', 'R_O5'], ['R_O5', 'P_A'], ['P_A', 'O_A1', true], ['P_A', 'O_A2'], ['P_A', 'O_AB'], ['O_AB', 'P_B'], ['P_B', 'O_B1', true], ['P_B', 'O_BC'], ['O_BC', 'P_G'], ['P_G', 'O_G1', true], ['P_G', 'O_G2']];
            bonds.forEach(([a, b, isDouble]) => {
                if(isDouble) {
                    mainGroup.add(createBondMesh(atoms[a].position.clone().setZ(0.1*scale), atoms[b].position.clone().setZ(0.1*scale), 0.08*scale));
                    mainGroup.add(createBondMesh(atoms[a].position.clone().setZ(-0.1*scale), atoms[b].position.clone().setZ(-0.1*scale), 0.08*scale));
                } else {
                    mainGroup.add(createBondMesh(atoms[a].position, atoms[b].position, 0.1*scale));
                }
            });
            const box = new THREE.Box3().setFromObject(mainGroup);
            const center = box.getCenter(new THREE.Vector3());
            mainGroup.children.forEach(c => c.position.sub(center));
        }

        // Mouse Hover
        function getHoveredAtom() {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(mainGroup.children, true);
            for (let i = 0; i < intersects.length; i++) {
                let obj = intersects[i].object;
                while (obj && !obj.userData?.type) {
                    obj = obj.parent;
                }
                if (obj && obj.userData && obj.userData.type === 'atom') {
                    return obj;
                }
            }
            return null;
        }

        function onMouseMove(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            const hoveredAtom = getHoveredAtom();
            
            if(canvasContainer.style.cursor !== 'grabbing'){
                if (lastHoveredAtom && lastHoveredAtom !== hoveredAtom) {
                    const material = lastHoveredAtom.children[0].material;
                    material.emissiveIntensity = lastHoveredAtom.userData.originalEmissive;
                }
                if (hoveredAtom) {
                    const material = hoveredAtom.children[0].material;
                    material.emissiveIntensity = 0.5;  
                    lastHoveredAtom = hoveredAtom;
                    canvasContainer.style.cursor = 'pointer';
                } else {
                    if(lastHoveredAtom) {
                        const material = lastHoveredAtom.children[0].material;
                        material.emissiveIntensity = lastHoveredAtom.userData.originalEmissive;
                    }
                    lastHoveredAtom = null;
                    canvasContainer.style.cursor = 'grab';
                }
            }
        }
        
        init();
    </script>
</body>
</html>

